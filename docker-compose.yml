version: "3.1"
services:

  apir:
    build:
        context: ./apir
        dockerfile: dev.Dockerfile
    container_name: dime_apir
    volumes:
        - ./apir:/apir
    working_dir: /apir
    command: "bundle exec rails server -p 8000 -b 0.0.0.0"
    depends_on:
        - mysql
    ports:
        - "38001:8000"
    environment:
        - DATABASE_HOST=mysql
        - DATABASE_USERNAME=root
        - DATABASE_PASSWORD=
        - DEVISE_JWT_SECRET_KEY=76561b6fe0a07360dadd731719089ef30441262d54ddf121b869801f9ffb1e2d53027703c02092d9276ca7fc3b69025f0724c85d55da29f0be0fde32853ab1e7
        - DEVISE_SECRET_KEY=8475131d4b4b3633b20e585e1f9006cf51a229d4b27342d53e2cbbba6b0937d88daf0c2b7613bc41a28dcb64e825455d4afd9b54b4d57db5b48046f99f0145e9

  guard:
    build:
        context: ./apir
        dockerfile: dev.Dockerfile
    volumes:
        - ./apir:/apir
    working_dir: /apir
    command: bash -c "bundle && bundle exec guard --no-interactions"
    depends_on:
        - mysql
    environment:
        - DATABASE_HOST=mysql
        - DATABASE_USERNAME=root
        - DATABASE_PASSWORD=
        - DEVISE_JWT_SECRET_KEY=verysecret
        - DEVISE_SECRET_KEY=verysecret

  mysql:
    image: mysql:5.7
    command: mysqld --sql_mode="NO_ENGINE_SUBSTITUTION"
    container_name: dime_db
    environment:
      - MYSQL_ALLOW_EMPTY_PASSWORD=1
    ports:
      - "33306:3306"
    volumes:
      - ./database:/var/lib/mysql

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: dime_phpmyadmin
    environment:
      - PMA_ARBITRARY=1
    ports:
      - 38080:80

  frontend:
    image: node:12
    container_name: dime_frontend
    volumes:
      - ./frontend:/var/frontend
    working_dir: /var/frontend
    ports:
      - "33000:3000"
    command: bash -c "yarn install && yarn run start"
